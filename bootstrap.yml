# SPDX-FileCopyrightText: 2026 Dominik Wombacher <dominik@wombacher.cc>
#
# SPDX-License-Identifier: Apache-2.0

---
- name: Bootstrap managed node
  hosts: all, !localhost
  gather_facts: false
  remote_user: root

  tasks:
    - name: Create user
      ansible.builtin.user:
        comment: automation user
        create_home: true
        name: ansible42
        password_lock: true
        password: '*' # disable user on Linux and FreeBSD, allows SSH key based auth
        remove: true # This only affects state=absent
        shell: /bin/sh
        state: present

    - name: Upload SSH public key
      ansible.posix.authorized_key:
        exclusive: true
        user: ansible42
        key: |
           {{ lookup('file', 'files/ansible42.pub') }}
           {{ lookup('file', 'files/wombelix.pub') }}
        manage_dir: true
        path: /home/ansible42/.ssh/authorized_keys
        state: present

    - name: Grant sudo permissions
      ansible.builtin.copy:
        content: "ansible42 ALL=(ALL) NOPASSWD: ALL"
        dest: "/etc/sudoers.d/ansible42"
        owner: root
        group: root
        mode: '440'
        validate: visudo -csf %s

    - name: Upgrade installed packages # noqa: package-latest
      ansible.builtin.apt:
        name: "*"
        autoclean: true
        autoremove: true
        update_cache: true
        state: latest

- name: OS and SSH Hardening
  import_playbook: hardening.yml
...
